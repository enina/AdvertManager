<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE hibernate-mapping PUBLIC "-//Hibernate/Hibernate Mapping DTD 3.0//EN" "http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">
<hibernate-mapping>
    <!-- Filterable behavior statistics start -->
    <class name="com.mne.advertmanager.model.FilterableBehaviorStatistics"
           table="behavior_stats_daily" 
           entity-name="DailyBehaviorStats">

        <id name="id" column="id">
            <generator class="native"/>
        </id>
        
        <many-to-one	column="affprogram_id"
                        name="affProgram" class="com.mne.advertmanager.model.AffProgram"
                        foreign-key="DAILY_BEHAVIOR_STAT_AFFPROGRAM_FK"/>
                         
        <many-to-one	column="domain_id"
                        name="source" class="com.mne.advertmanager.model.AccessSource"
                        foreign-key="DAILY_BEHAVIOR_STAT_ACCESSSOURCE_FK"/>

        <property name="countryCode" column="cc"/>
        <property name="countryName"/>
        <property name="accessAmount"/>
        <property name="purchaseAmount"/>
        <property name="totalCommision"/>
    </class>  

    <class name="com.mne.advertmanager.model.FilterableBehaviorStatistics"
           table="behavior_stats_curmonth" 
           entity-name="CurMonthBehaviorStats">

        <id name="id" column="id">
            <generator class="native"/>
        </id>
        
        <many-to-one	column="affprogram_id"
                        name="affProgram" class="com.mne.advertmanager.model.AffProgram"
                        foreign-key="CURMONTH_BEHAVIOR_STAT_AFFPROGRAM_FK"/>
                         
        <many-to-one	column="domain_id"
                        name="source" class="com.mne.advertmanager.model.AccessSource"
                        foreign-key="CURMONTH_BEHAVIOR_STAT_ACCESSSOURCE_FK"/>
        
        <property name="countryCode" column="cc"/>
        <property name="countryName"/>
        <property name="accessAmount"/>
        <property name="purchaseAmount"/>
        <property name="totalCommision"/>
    </class>  
    
    <class name="com.mne.advertmanager.model.FilterableBehaviorStatistics"
           table="behavior_stats_prevmonth" 
           entity-name="PrevMonthBehaviorStats">

        <id name="id" column="id">
            <generator class="native"/>
        </id>
        
        <many-to-one     column="affprogram_id"
                         name="affProgram" class="com.mne.advertmanager.model.AffProgram"
                         foreign-key="PREVMONTH_BEHAVIOR_STAT_AFFPROGRAM_FK"/>
                         
        <many-to-one     column="domain_id"
                         name="source" class="com.mne.advertmanager.model.AccessSource"
                         foreign-key="PREVMONTH_BEHAVIOR_STAT_ACCESSSOURCE_FK"/>

        <property name="countryCode" column="cc"/>
        <property name="countryName"/>
        <property name="accessAmount"/>
        <property name="purchaseAmount"/>
        <property name="totalCommision"/>
    </class>  
    
    <class name="com.mne.advertmanager.model.FilterableBehaviorStatistics"
           table="behavior_stats_total" 
           entity-name="TotalBehaviorStats">

        <id name="id" column="id">
            <generator class="native"/>
        </id>
        
        <many-to-one column="affprogram_id" lazy="false"
                     name="affProgram" class="com.mne.advertmanager.model.AffProgram"
                     foreign-key="TOTAL_BEHAVIOR_STAT_AFFPROGRAM_FK"/>
                         
        <many-to-one column="domain_id" lazy="false"
                     name="source" class="com.mne.advertmanager.model.AccessSource"
                     foreign-key="TOTAL_BEHAVIOR_STAT_ACCESSSOURCE_FK"/>
        <property name="countryCode" column="cc"/>
        <property name="countryName"/>
        <property name="accessAmount"/>
        <property name="purchaseAmount"/>
        <property name="totalCommision"/>
    </class>    

<!--===========================  querys  ====================================-->

<!--select *
from behavior_stats_total

inner join 
    aff_program
on
    aff_program.id = behavior_stats_total.affprogram_id

where 
     behavior_stats_total.`countryName` is not null and
     behavior_stats_total.`countryName` != "Filter.all" 
     order by behavior_stats_total.accessAmount desc-->
     <query name="TotalBehaviorStats.findTotalAccessesByCountry" ><![CDATA[
        from
            TotalBehaviorStats tbs
            left join fetch tbs.affProgram prog
        where
            tbs.countryName is not null and
            tbs.countryName != 'Filter.All' and
            prog.id=? 
     ]]>
     </query>
     
    <query name="TotalBehaviorStats.findAffiliateCountryStats"><![CDATA[
        from
            TotalBehaviorStats tbs
            left join fetch tbs.affProgram prog
            left join fetch prog.apg apg
            left join fetch apg.affiliateId affiliate
        where
            affiliate.id=? and tbs.countryName=? 
    ]]>
    </query>
    
     <query name="TotalBehaviorStats.findTotalAccesAmountByDomain"><![CDATA[
        from
            TotalBehaviorStats tbs
            left join fetch tbs.source src
            left join fetch tbs.affProgram prog
        where
            src is not null and prog.id=? 
            order by 
            tbs.accessAmount desc
    ]]>
    </query>


    
    <query name="TotalBehaviorStats.findAffProgCountryStats"><![CDATA[
        from TotalBehaviorStats where affProgram.id=? and countryName=? 
    ]]>
    </query>
    
    <query name="TotalBehaviorStats.findAffProgStats"><![CDATA[
        from TotalBehaviorStats where  affProgram.id=? 
    ]]>
    </query>    
    
    <query name="PrevMonthBehaviorStats.findAffProgCountryStats"><![CDATA[
        from PrevMonthBehaviorStats where affProgram.id=? and countryName=?
    ]]>
    </query>

    <query name="PrevMonthBehaviorStats.findAffProgStats"><![CDATA[
        from PrevMonthBehaviorStats where affProgram.id=?
    ]]>
    </query>

    <query name="PrevMonthBehaviorStats.deleteAffProgStats"><![CDATA[
        delete from PrevMonthBehaviorStats where affProgram.id=?
    ]]>
    </query>    
    
    
    <query name="CurMonthBehaviorStats.findAffProgCountryStats"><![CDATA[
        from CurMonthBehaviorStats where affProgram.id=? and countryName=?
    ]]>
    </query>

    <query name="CurMonthBehaviorStats.findAffProgStats"><![CDATA[
        from CurMonthBehaviorStats where affProgram.id=?
    ]]>
    </query>
    
    <query name="CurMonthBehaviorStats.deleteAffProgStats"><![CDATA[
        delete from CurMonthBehaviorStats where affProgram.id=?
    ]]>
    </query>    
    
    
    <query name="DailyBehaviorStats.findAffProgCountryStats"><![CDATA[
        from DailyBehaviorStats where affProgram.id=? and countryName=?
    ]]>
    </query>
    
    <query name="DailyBehaviorStats.findAffProgStats"><![CDATA[
        from DailyBehaviorStats where  affProgram.id=? 
    ]]>
    </query>    
    
    
    <query name="DailyBehaviorStats.deleteAffProgStats"><![CDATA[
        delete from DailyBehaviorStats where affProgram.id=?
    ]]>
    </query>    
    
    <query name="BehaviorStats.calcAffProgPeriodTotalFinancialStats"><![CDATA[
        SELECT
            new com.mne.advertmanager.model.FilterableBehaviorStatistics(count (po),sum(po.commision),po.affProgram)
        FROM
            PurchaseOrder po 
        WHERE 
            po.affProgram.id = ? and po.ordertime > ?
    ]]>
    </query>
    
    <!--
SELECT count(affprogram_id) as poAmount,sum(commision) ,cn,affprogram_id FROM 
(select * from purchase_order group by ip_address) t1
group by cn
-->
    
    <query name="BehaviorStats.calcAffProgPeriodFinancialStatsByCountry"><![CDATA[
        SELECT
            new com.mne.advertmanager.model.FilterableBehaviorStatistics(count(po),sum(po.commision),po.countryName,po.countryCode,po.affProgram)
        FROM
            PurchaseOrder po
	WHERE
	    po in (select po from PurchaseOrder po  where po.affProgram.id = ? and po.ordertime > ?  group by po.ipAddress)
        GROUP BY
	    po.countryName
    ]]>
    </query>  
    
    <!--
select count(*) as accessAmount,source_domain_id,affprogram_id
    from 
(SELECT * FROM access_log group by ip_address) access_log 
    where
source_domain_id is not null
    group by 
source_domain_id    
    -->
    
    <query name="BehaviorStats.calcAffProgPeriodDomainStats"><![CDATA[
        SELECT 
            new com.mne.advertmanager.model.FilterableBehaviorStatistics (count (acl),acl.sourceDomain,acl.affProgram) 
         FROM  AccessLog acl 
         WHERE
            acl in (select acl from AccessLog acl  where acl.affProgram.id = ? and acl.accessTime > ?  group by ip_address)
         GROUP BY 
            acl.sourceDomain
    ]]>
    </query>
    
    <query name="BehaviorStats.calcAffProgPeriodCountryStats"><![CDATA[
        SELECT 
            new com.mne.advertmanager.model.FilterableBehaviorStatistics (count (acl),acl.countryName,acl.countryCode ,acl.affProgram) 
         FROM  AccessLog acl 
         WHERE
            acl in (select acl from AccessLog acl  where acl.affProgram.id = ? and acl.accessTime > ?  group by ip_address)
         GROUP BY 
            acl.countryName
    ]]>
    </query>
    
  
</hibernate-mapping>
