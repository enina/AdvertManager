<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE hibernate-mapping PUBLIC "-//Hibernate/Hibernate Mapping DTD 3.0//EN" "http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">
<hibernate-mapping>
    <class dynamic-insert="false" dynamic-update="false"  
            mutable="true" optimistic-lock="version" 
            polymorphism="implicit" select-before-update="false" 
            name="com.mne.advertmanager.model.PurchaseOrderAggregation"
            table="purchase_order_total_aggr"
            entity-name="PurchaseOrderTotalAggregation">

            <id name="id" column="id">
                <generator class="native"/>
            </id>
            <property name="accessAmount"/>        
            <property name="totalCommision"/>
            <property name="purchaseAmount"/>
            <property name="conversionRate"/>
            <many-to-one unique="true" column="affprogram_id"
                         name="affProgram" class="com.mne.advertmanager.model.AffProgram"
                         foreign-key="PO_TOTAL_AGGR_AFFPROGRAM_FK"/>  
    </class>
  
    <class dynamic-insert="false" dynamic-update="false"  
        mutable="true" optimistic-lock="version" 
        polymorphism="implicit" select-before-update="false" 
        name="com.mne.advertmanager.model.PurchaseOrderAggregation"
        table="purchase_order_prevmonth_aggr"
        entity-name="PurchaseOrderPrevMonthAggregation">
        
        <id name="id" column="id">
            <generator class="native"/>
        </id>
        <property name="accessAmount"/>        
        <property name="totalCommision"/>
        <property name="purchaseAmount"/>
        <property name="conversionRate"/>
        <many-to-one unique="true" column="affprogram_id"
                    name="affProgram" class="com.mne.advertmanager.model.AffProgram"
                    foreign-key="PO_PREVMONTH_AGGR_AFFPROGRAM_FK"/>  
    </class>
  
    <class dynamic-insert="false" dynamic-update="false"  
            mutable="true" optimistic-lock="version" 
            polymorphism="implicit" select-before-update="false" 
            name="com.mne.advertmanager.model.PurchaseOrderAggregation"
            table="purchase_order_curmonth_aggr"
            entity-name="PurchaseOrderCurMonthAggregation">

            <id name="id" column="id">
                <generator class="native"/>
            </id>
            <property name="accessAmount"/>        
            <property name="totalCommision"/>
            <property name="purchaseAmount"/>
            <property name="conversionRate"/>
            <many-to-one unique="true" column="affprogram_id"
                        name="affProgram" class="com.mne.advertmanager.model.AffProgram"
                        foreign-key="PO_CURMONTH_AGGR_AFFPROGRAM_FK"/>
    </class>  

    <class dynamic-insert="false" dynamic-update="false"  
            mutable="true" optimistic-lock="version" 
            polymorphism="implicit" select-before-update="false" 
            name="com.mne.advertmanager.model.PurchaseOrderAggregation"
            table="purchase_order_today_aggr"
            entity-name="PurchaseOrderDailyAggregation">

            <id name="id" column="id">
                <generator class="native"/>
            </id>
            <property name="accessAmount"/>        
            <property name="totalCommision"/>
            <property name="purchaseAmount"/>
            <property name="conversionRate"/>
            <many-to-one unique="true" column="affprogram_id"
                        name="affProgram" class="com.mne.advertmanager.model.AffProgram"
                        foreign-key="PO_TODAY_AGGR_AFFPROGRAM_FK"/>
    </class>  
    
    <!-- Geo Classified Statistics Start -->
    <class dynamic-insert="false" dynamic-update="false"  mutable="true" optimistic-lock="version" 
           polymorphism="implicit" select-before-update="false"  
           name="com.mne.advertmanager.model.GeoClassifiedPOStatistics"
           table="geoclassified_po_today_statistics" entity-name="GeoClassifiedPODailyStatistics">

        <id name="id" column="id">
            <generator class="native"/>
        </id>
        
        <many-to-one unique="true" column="affprogram_id"
                         name="affProgram" class="com.mne.advertmanager.model.AffProgram"
                         foreign-key="GEO_PO_TODAY_STAT_AFFPROGRAM_FK"/>
                         
        <many-to-one unique="true" column="domain_id"
                         name="source" class="com.mne.advertmanager.model.AccessSource"
                         foreign-key="GEO_PO_TODAY_STAT_ACCESSSOURCE_FK"/>

        <property name="countryName"/>
        <property name="accessAmount"/>
        <property name="purchaseAmount"/>
    </class>  

    <!-- Geo Classified Statistics Finish -->

    <query name="PurchaseOrderTotalAggregation.findByAffProgId"><![CDATA[
        from PurchaseOrderTotalAggregation where affProgram.id=?
    ]]>
    </query>
    
    <query name="PurchaseOrderPrevMonthAggregation.findByAffProgId"><![CDATA[
        from PurchaseOrderPrevMonthAggregation where affProgram.id=?
    ]]>
    </query>
    
    <query name="PurchaseOrderCurMonthAggregation.findByAffProgId"><![CDATA[
        from PurchaseOrderCurMonthAggregation where affProgram.id=?
    ]]>
    </query>
    
    <query name="PurchaseOrderDailyAggregation.findByAffProgId"><![CDATA[
        from PurchaseOrderDailyAggregation where affProgram.id=?
    ]]>
    </query>
    
    <query name="PurchaseOrderAggregation.calculateAffProgDataByIdAndTime"><![CDATA[
        SELECT new com.mne.advertmanager.model.PurchaseOrderAggregation(count (po),sum(commision),po.affProgram) FROM PurchaseOrder po WHERE po.affProgram.id = ? and ordertime > ?
    ]]>
    </query>
    
    <!--
select count(*) as accessAmount,source_domain_id,affprogram_id
    from 
(SELECT * FROM access_log group by ip_address) access_log 
    where
source_domain_id is not null
    group by 
source_domain_id    
    -->
    
    <query name="GeoClassifiedPOStat.countAccessByDomain"><![CDATA[
        SELECT 
            new com.mne.advertmanager.model.GeoClassifiedPOStatistics (count (acl),acl.sourceDomain,acl.affProgram)
         FROM 
            (from AccessLog group by ip_address) acl
         WHERE 
            acl.sourceDomain is not null 
         GROUP BY 
            acl.sourceDomain
    ]]>
    </query>
    
    <query name="GeoClassifiedPOStat.countPurchaseByDomain"><![CDATA[
        SELECT 
            new com.mne.advertmanager.model.GeoClassifiedPOStatistics (count (acl),acl.sourceDomain,acl.affProgram)
         FROM 
            (from AccessLog group by ip_address) acl
         WHERE 
            acl.sourceDomain is not null 
         GROUP BY 
            acl.sourceDomain
    ]]>
    </query>
        
  
</hibernate-mapping>
