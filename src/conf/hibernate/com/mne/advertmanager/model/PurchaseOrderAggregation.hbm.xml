<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE hibernate-mapping PUBLIC "-//Hibernate/Hibernate Mapping DTD 3.0//EN" "http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">
<hibernate-mapping>
    <!-- Filterable behavior statistics start -->
    <class name="com.mne.advertmanager.model.FilterableBehaviorStatistics"
           table="daily_behavior_stats" 
           entity-name="DailyBehaviorStats">

        <id name="id" column="id">
            <generator class="native"/>
        </id>
        
        <many-to-one unique="true" column="affprogram_id"
                         name="affProgram" class="com.mne.advertmanager.model.AffProgram"
                         foreign-key="DAILY_BEHAVIOR_STAT_AFFPROGRAM_FK"/>
                         
        <many-to-one unique="true" column="domain_id"
                         name="source" class="com.mne.advertmanager.model.AccessSource"
                         foreign-key="DAILY_BEHAVIOR_STAT_ACCESSSOURCE_FK"/>

        <property name="countryName"/>
        <property name="accessAmount"/>
        <property name="purchaseAmount"/>
        <property name="totalCommision"/>
    </class>  

    <class name="com.mne.advertmanager.model.FilterableBehaviorStatistics"
           table="curmonth_behavior_stats" 
           entity-name="CurMonthBehaviorStats">

        <id name="id" column="id">
            <generator class="native"/>
        </id>
        
        <many-to-one unique="true" column="affprogram_id"
                         name="affProgram" class="com.mne.advertmanager.model.AffProgram"
                         foreign-key="CURMONTH_BEHAVIOR_STAT_AFFPROGRAM_FK"/>
                         
        <many-to-one unique="true" column="domain_id"
                         name="source" class="com.mne.advertmanager.model.AccessSource"
                         foreign-key="CURMONTH_BEHAVIOR_STAT_ACCESSSOURCE_FK"/>

        <property name="countryName"/>
        <property name="accessAmount"/>
        <property name="purchaseAmount"/>
        <property name="totalCommision"/>
    </class>  
    
    <class name="com.mne.advertmanager.model.FilterableBehaviorStatistics"
           table="prevmonth_behavior_stats" 
           entity-name="PrevMonthBehaviorStats">

        <id name="id" column="id">
            <generator class="native"/>
        </id>
        
        <many-to-one unique="true" column="affprogram_id"
                         name="affProgram" class="com.mne.advertmanager.model.AffProgram"
                         foreign-key="PREVMONTH_BEHAVIOR_STAT_AFFPROGRAM_FK"/>
                         
        <many-to-one unique="true" column="domain_id"
                         name="source" class="com.mne.advertmanager.model.AccessSource"
                         foreign-key="PREVMONTH_BEHAVIOR_STAT_ACCESSSOURCE_FK"/>

        <property name="countryName"/>
        <property name="accessAmount"/>
        <property name="purchaseAmount"/>
        <property name="totalCommision"/>
    </class>  
    
    <class name="com.mne.advertmanager.model.FilterableBehaviorStatistics"
           table="total_behavior_stats" 
           entity-name="TotalBehaviorStats">

        <id name="id" column="id">
            <generator class="native"/>
        </id>
        
        <many-to-one unique="true" column="affprogram_id"
                         name="affProgram" class="com.mne.advertmanager.model.AffProgram"
                         foreign-key="TOTAL_BEHAVIOR_STAT_AFFPROGRAM_FK"/>
                         
        <many-to-one unique="true" column="domain_id"
                         name="source" class="com.mne.advertmanager.model.AccessSource"
                         foreign-key="TOTAL_BEHAVIOR_STAT_ACCESSSOURCE_FK"/>

        <property name="countryName"/>
        <property name="accessAmount"/>
        <property name="purchaseAmount"/>
        <property name="totalCommision"/>
    </class>    


    <query name="TotalBehaviorStats.findByAffProgId"><![CDATA[
        from TotalBehaviorStats where countryName='TOTAL' and affProgram.id=? 
    ]]>
    </query>
    
    <query name="PrevMonthBehaviorStats.findByAffProgId"><![CDATA[
        from PrevMonthBehaviorStats where countryName='TOTAL' and affProgram.id=?
    ]]>
    </query>
    
    <query name="CurMonthBehaviorStats.findByAffProgId"><![CDATA[
        from CurMonthBehaviorStats where countryName='TOTAL' and affProgram.id=?
    ]]>
    </query>
    
    <query name="DailyBehaviorStats.findByAffProgId"><![CDATA[
        from DailyBehaviorStats where countryName='TOTAL' and  affProgram.id=?
    ]]>
    </query>
    
    <query name="BehaviorStats.calculateAffProgStatsByIdAndTime"><![CDATA[
        SELECT
            new com.mne.advertmanager.model.FilterableBehaviorStatistics(count (po),sum(commision),po.affProgram)
        FROM
            PurchaseOrder po
        WHERE 
            po.affProgram.id = ? and ordertime > ?
    ]]>
    </query>
    
    <!--
select count(*) as accessAmount,source_domain_id,affprogram_id
    from 
(SELECT * FROM access_log group by ip_address) access_log 
    where
source_domain_id is not null
    group by 
source_domain_id    
    -->
    
    <query name="BehaviorStats.countAffProgramPeriodicAccessByDomain"><![CDATA[
        SELECT 
            new com.mne.advertmanager.model.FilterableBehaviorStatistics (count (acl),acl.sourceDomain,acl.affProgram)
         FROM  AccessLog acl 
         WHERE
            acl in (select acl from AccessLog acl where acl.affProgram.id = ? and acl.accessTime > ? group by ip_address) and
            acl.sourceDomain is not null 
         GROUP BY 
            acl.sourceDomain
    ]]>
    </query>
    
<!--    <query name="GeoClassifiedPOStat.countAccessByCountry"><![CDATA[
        SELECT 
            new com.mne.advertmanager.model.GeoClassifiedPOStatistics (count (acl),acl.sourceDomain,acl.affProgram)
         FROM 
            (select acl from AccessLog acl group by ip_address) acl
         WHERE 
            acl.countryName is not null 
         GROUP BY 
            acl.countryName
    ]]>
    </query>    
    
    <query name="GeoClassifiedPOStat.countPurchaseByDomain"><![CDATA[
        SELECT 
            new com.mne.advertmanager.model.GeoClassifiedPOStatistics (count (po),po.affProgram)
         FROM 
            (select po from PurchaseOrder po group by ip_address) po
         WHERE 
            po.ip_address is not null 
         GROUP BY 
            po.countryName
    ]]>
    </query>-->
        
  
</hibernate-mapping>
